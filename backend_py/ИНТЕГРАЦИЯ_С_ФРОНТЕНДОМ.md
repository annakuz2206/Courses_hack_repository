# üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Telegram –±–æ—Ç–∞ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞

### –ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `/login` –≤ Telegram –±–æ—Ç—É
2. **–ë–æ—Ç** –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
3. **–ë–æ—Ç** —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∞–π—Ç —Å –∫–æ–¥–æ–º –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ: `https://–≤–∞—à-—Å–∞–π—Ç.com/auth?code=ABC123`
4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ —Å–∞–π—Ç (–ø–æ —Å—Å—ã–ª–∫–µ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)
5. **–§—Ä–æ–Ω—Ç–µ–Ω–¥** —á–∏—Ç–∞–µ—Ç –∫–æ–¥ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `code`
6. **–§—Ä–æ–Ω—Ç–µ–Ω–¥** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ —á–µ—Ä–µ–∑ API
7. **–§—Ä–æ–Ω—Ç–µ–Ω–¥** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è JWT —Ç–æ–∫–µ–Ω–∞
8. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω! üéâ

## API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ (–±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

**GET** `/api/auth/bot-code/validate/{code}`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –ª–∏ –∫–æ–¥, –±–µ–∑ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–¥–∞ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```bash
GET http://localhost:8000/api/auth/bot-code/validate/ABC123
```

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç (200):**
```json
{
  "valid": true,
  "message": "–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω",
  "user_name": "–ò–≤–∞–Ω"
}
```

**–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–¥ (200):**
```json
{
  "valid": false,
  "message": "–ö–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, –∏—Å—Ç—ë–∫ –∏–ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω",
  "user_name": null
}
```

### 2. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫–æ–¥

**POST** `/api/auth/bot-code`

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–¥ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –≤—ã–¥–∞—ë—Ç JWT —Ç–æ–∫–µ–Ω. –ö–æ–¥ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```bash
POST http://localhost:8000/api/auth/bot-code
Content-Type: application/json

{
  "code": "ABC123"
}
```

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç (200):**
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "token_type": "bearer"
}
```

**–û—à–∏–±–∫–∞ (401):**
```json
{
  "detail": "–ö–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, –∏—Å—Ç—ë–∫ –∏–ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω"
}
```

## –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

### React / Next.js –ø—Ä–∏–º–µ—Ä:

```typescript
// auth.tsx –∏–ª–∏ useAuth.ts
import { useEffect, useState } from 'react';
import { useSearchParams } from 'next/navigation'; // –¥–ª—è Next.js
// –∏–ª–∏ useSearchParams –∏–∑ react-router –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ React

const API_URL = 'http://localhost:8000';

export function useTelegramAuth() {
  const [searchParams] = useSearchParams();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const code = searchParams.get('code');
    
    if (!code) {
      return; // –ù–µ—Ç –∫–æ–¥–∞ –≤ URL
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
    validateCode(code);
  }, [searchParams]);

  async function validateCode(code: string) {
    setLoading(true);
    setError(null);

    try {
      // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
      const validateResponse = await fetch(
        `${API_URL}/api/auth/bot-code/validate/${code}`
      );
      const validateData = await validateResponse.json();

      if (!validateData.valid) {
        setError(validateData.message);
        setLoading(false);
        return;
      }

      // 2. –ï—Å–ª–∏ –∫–æ–¥ –≤–∞–ª–∏–¥–µ–Ω, –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è
      const authResponse = await fetch(`${API_URL}/api/auth/bot-code`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ code }),
      });

      if (!authResponse.ok) {
        const errorData = await authResponse.json();
        throw new Error(errorData.detail || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
      }

      const { access_token } = await authResponse.json();
      
      // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
      localStorage.setItem('token', access_token);
      
      // 4. –£–±–∏—Ä–∞–µ–º code –∏–∑ URL
      window.history.replaceState({}, '', window.location.pathname);
      
      // 5. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      window.location.reload(); // –∏–ª–∏ –≤–∞—à —Ä–æ—É—Ç–∏–Ω–≥
      
    } catch (err) {
      setError(err instanceof Error ? err.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
    } finally {
      setLoading(false);
    }
  }

  return { loading, error };
}
```

### Vanilla JavaScript –ø—Ä–∏–º–µ—Ä:

```javascript
// auth.js
const API_URL = 'http://localhost:8000';

async function handleTelegramAuth() {
  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');

  if (!code) {
    return; // –ù–µ—Ç –∫–æ–¥–∞
  }

  try {
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
    const validateResponse = await fetch(
      `${API_URL}/api/auth/bot-code/validate/${code}`
    );
    const validateData = await validateResponse.json();

    if (!validateData.valid) {
      alert(validateData.message);
      return;
    }

    // 2. –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è
    const authResponse = await fetch(`${API_URL}/api/auth/bot-code`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ code }),
    });

    if (!authResponse.ok) {
      const errorData = await authResponse.json();
      throw new Error(errorData.detail || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
    }

    const { access_token } = await authResponse.json();
    
    // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
    localStorage.setItem('token', access_token);
    
    // 4. –£–±–∏—Ä–∞–µ–º code –∏–∑ URL
    window.history.replaceState({}, '', window.location.pathname);
    
    // 5. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
    window.location.href = '/dashboard'; // –∏–ª–∏ –≤–∞—à —Ä–æ—É—Ç–∏–Ω–≥
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
    alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
  }
}

// –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
if (window.location.pathname === '/auth' || window.location.search.includes('code=')) {
  handleTelegramAuth();
}
```

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 5 –º–∏–Ω—É—Ç** - –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç
2. **–ö–æ–¥ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π** - –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –µ–≥–æ –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
3. **URL –ø–∞—Ä–∞–º–µ—Ç—Ä** - –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –≤–∏–¥–∞ `https://site.com/auth?code=ABC123`
4. **CORS** - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–º–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω –≤ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—ç–∫–µ–Ω–¥–∞

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS

–í `main.py` —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω CORS –¥–ª—è:
- `http://localhost:3000` (React)
- `http://localhost:5173` (Vite)
- `http://localhost:8080` (Vue)

–î–ª—è production –¥–æ–±–∞–≤—å—Ç–µ –≤–∞—à –¥–æ–º–µ–Ω –≤ `allow_origins` –≤ `main.py`.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±—ç–∫–µ–Ω–¥: `python3 main.py`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Telegram –±–æ—Ç–∞: `python3 telegram_bot.py`
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/login` –±–æ—Ç—É
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

## Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Swagger UI:
- http://localhost:8000/docs

–¢–∞–º –º–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.

